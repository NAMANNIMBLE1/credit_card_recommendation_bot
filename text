import os
import sys
from dotenv import load_dotenv
load_dotenv()
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))

from utilities.get_prompt import get_prompt_template
from utilities.chroma_db import get_chroma_db
from langchain_huggingface import HuggingFaceEndpoint
from langchain_core.prompts import PromptTemplate
from langchain_core.runnables import RunnablePassthrough
from langchain_core.output_parsers import StrOutputParser


def get_retriever():
    """
    Converts the VectorStore returned by ChromaDB into a retriever.
    """
    vectorstore = get_chroma_db()
    retriever = vectorstore.as_retriever(search_kwargs={"k": 5})
    return retriever

def get_custom_prompt():
    """
    Returns a PromptTemplate using your imported template string.
    """
    prompt_template_str = get_prompt_template()
    return PromptTemplate(
        input_variables=["context", "question"],
        template=prompt_template_str
    )

def get_llm():
    """
    Returns a HuggingFace LLM 
    """
    llm = HuggingFaceEndpoint(
        repo_id="mistralai/Mistral-Nemo-Base-2407",
        provider="novita",
        max_new_tokens=100,
        do_sample=False,
        huggingfacehub_api_token="my-api-key"
    )
    return llm


def get_rag_chain():
    """
    Constructs the RAG chain using the retriever, prompt, and LLM.
    """
    retriever = get_retriever()
    prompt = get_custom_prompt()
    llm = get_llm()
    rag_chain = (
        {"context": retriever, "question": RunnablePassthrough()}
        | prompt
        | llm
        | StrOutputParser()
    )
    return rag_chain


if __name__ == "__main__":
    
    chain = get_rag_chain()
    answer = chain.invoke("recommend me a card i earn 7000 rupees per month")
    print(answer)


this is my code above and it is giving me error : 

File "/usr/lib/python3.13/site-packages/huggingface_hub/utils/_http.py", line 409, in hf_raise_for_status
    response.raise_for_status()
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/usr/lib/python3.13/site-packages/requests/models.py", line 1026, in raise_for_status
    raise HTTPError(http_error_msg, response=self)
requests.exceptions.HTTPError: 401 Client Error: Unauthorized for url: https://huggingface.co/api/models/mistralai/Mistral-Nemo-Base-2407?expand=inferenceProviderMapping

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/nex/Documents/qa_chatbot/rag_chain/llm_chain.py", line 66, in <module>
    answer = chain.invoke("recommend me a card i earn 7000 rupees per month")
  File "/home/nex/.local/lib/python3.13/site-packages/langchain_core/runnables/base.py", line 3047, in invoke
    input_ = context.run(step.invoke, input_, config)
  File "/home/nex/.local/lib/python3.13/site-packages/langchain_core/language_models/llms.py", line 389, in invoke
    self.generate_prompt(
    ~~~~~~~~~~~~~~~~~~~~^
        [self._convert_input(input)],
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
        **kwargs,
        ^^^^^^^^^
    )
    ^
  File "/home/nex/.local/lib/python3.13/site-packages/langchain_core/language_models/llms.py", line 766, in generate_prompt
    return self.generate(prompt_strings, stop=stop, callbacks=callbacks, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/nex/.local/lib/python3.13/site-packages/langchain_core/language_models/llms.py", line 973, in generate
    return self._generate_helper(
           ~~~~~~~~~~~~~~~~~~~~~^
        prompts,
        ^^^^^^^^
    ...<3 lines>...
        **kwargs,
        ^^^^^^^^^
    )
    ^
  File "/home/nex/.local/lib/python3.13/site-packages/langchain_core/language_models/llms.py", line 792, in _generate_helper
    self._generate(
    ~~~~~~~~~~~~~~^
        prompts,
        ^^^^^^^^
    ...<3 lines>...
        **kwargs,
        ^^^^^^^^^
    )
    ^
  File "/home/nex/.local/lib/python3.13/site-packages/langchain_core/language_models/llms.py", line 1547, in _generate
    self._call(prompt, stop=stop, run_manager=run_manager, **kwargs)
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/nex/.local/lib/python3.13/site-packages/langchain_huggingface/llms/huggingface_endpoint.py", line 312, in _call
    response_text = self.client.text_generation(
        prompt=prompt,
        model=self.model,
        **invocation_params,
    )
  File "/usr/lib/python3.13/site-packages/huggingface_hub/inference/_client.py", line 2297, in text_generation
    request_parameters = provider_helper.prepare_request(
        inputs=prompt,
    ...<4 lines>...
        api_key=self.token,
    )
  File "/usr/lib/python3.13/site-packages/huggingface_hub/inference/_providers/_common.py", line 70, in prepare_request
    provider_mapping_info = self._prepare_mapping_info(model)
  File "/usr/lib/python3.13/site-packages/huggingface_hub/inference/_providers/_common.py", line 130, in _prepare_mapping_info
    for mapping in _fetch_inference_provider_mapping(model):
                   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/usr/lib/python3.13/site-packages/huggingface_hub/inference/_providers/_common.py", line 257, in _fetch_inference_provider_mapping
    info = HfApi().model_info(model, expand=["inferenceProviderMapping"])
  File "/usr/lib/python3.13/site-packages/huggingface_hub/utils/_validators.py", line 114, in _inner_fn
    return fn(*args, **kwargs)
  File "/usr/lib/python3.13/site-packages/huggingface_hub/hf_api.py", line 2629, in model_info
    hf_raise_for_status(r)
    ~~~~~~~~~~~~~~~~~~~^^^
  File "/usr/lib/python3.13/site-packages/huggingface_hub/utils/_http.py", line 482, in hf_raise_for_status
    raise _format(HfHubHTTPError, str(e), response) from e
huggingface_hub.errors.HfHubHTTPError: 401 Client Error: Unauthorized for url: https://huggingface.co/api/models/mistralai/Mistral-Nemo-Base-2407?expand=inferenceProviderMapping (Request ID: Root=1-68515f42-3a35026034aa5c0033e15630;1b86bc08-5668-44d1-a553-3072d8ae8648)

Invalid credentials in Authorization header